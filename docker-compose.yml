version: '2'

#networks:
#    default:
#        external:
#             name: local_net

services:

    installing:
        container_name: installing
        build: ./app
        volumes:
          - ./jeedom:/app
          
    jeedom:
        container_name: fpm-jeedom
        build: ./php
        privileged: false
        pid: "host"
        cap_add:
             - SYS_PTRACE
        # tty: true
        hostname: jeedom
        #mac_address: a0:ca:ab:cd:ef:02
        #networks:
        #     default:
        #        ipv4_address: 192.168.1.11
        # devices:
        #     - "/dev/ttyUSB0"
        #     - "/dev/ttyUSB1"
        #     - "/dev/ttyACM0"
        restart: unless-stopped
        volumes:
          - ./jeedom:/var/www/html
          - ./backup:/var/www/html/backup
        depends_on:
          - installing
      healthcheck:
        test: ["CMD-SHELL", "curl -so /tmp/status http://nginx-jeedom/status || exit 1"]
        timeout: 10s


    # Scheduler Service
    scheduler:
      image: mcuadros/ofelia:latest
      container_name: ofelia
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
        - ./ofelia.ini:/etc/ofelia/config.ini
      depends_on:
        - jeedom


    nginx:
      image: nginx:alpine
      container_name: nginx-jeedom
      working_dir: /var/www/html
      volumes:
          - ./jeedom:/var/www/html
          - ./nginx.conf:/etc/nginx/conf.d/default.conf
      ports:
       - "80:80"
      restart: unless-stopped
      # debug mode:
      # command: [nginx-debug, "-g", "daemon off;"]
      healthcheck:
        test: ["CMD-SHELL", "curl -so /dev/null http://localhost/here.html || exit 1"]
        timeout: 10s


    db:
        container_name: db
        image: ghcr.io/linuxserver/mariadb
        restart: unless-stopped
        # env_file:
        #     - ./.env
        environment:
          - PUID=1000
          - PGID=1000
          - MYSQL_ROOT_PASSWORD=admin
          - TZ=Europe/Paris
          - MYSQL_ALLOW_EMPTY_PASSWORD=yes
          - MYSQL_DATABASE=jeedom #optional
          - MYSQL_USER=jeedom #optional
          - MYSQL_PASSWORD=jeedom #optional
        healthcheck:
            test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
            timeout: 20s
            retries: 10
        # - REMOTE_SQL=http://URL1/your.sql,https://URL2/your.sql #optional
        volumes:
            - ./db:/config
        ports:
            - 3306:3306


    adminer:
        container_name: adminer
        image: adminer
        ports:
            - "8080:80"
