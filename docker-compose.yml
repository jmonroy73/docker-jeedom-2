version: '2.3'

networks:
  local_net:

services:

  # this container just git clone jeedom repo into host directory
  installing:
      container_name: installing
      build: ./app
      environment:
        - TZ=${TZ:-Europe/Paris}
      volumes:
        - ./jeedom:/app
          
  jeedom:
      container_name: jeedom
      build: ./php
      privileged: false
      pid: "host"
      cap_add:
           - SYS_PTRACE
      # tty: true
      hostname: jeedom
      environment:
        - TZ=${TZ:-Europe/Paris}
      devices:
      #     - "/dev/ttyUSB0"
      #     - "/dev/ttyUSB1"
          - "/dev/ttyACM0"
      restart: unless-stopped
      volumes:
        - ./jeedom:/var/www/html
        - ./backup:/var/www/html/backup
      depends_on:
        - installing
        - db
      healthcheck:
        test: ["CMD-SHELL", "curl -so /dev/null http://localhost/here.html || exit 1"]
        interval: 1m30s
        retries: 3
        start_period: 40s
        timeout: 20s
      networks:
        - local_net
      labels:
        - "traefik.http.routers.jeedom.rule=Host(`home.nico.si`)"


  # Scheduler Service
  scheduler:
    # image built from https://github.com/mcuadros/ofelia
    image: ofelia
    # image: mcuadros/ofelia:latest
    container_name: ofelia
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./ofelia.ini:/etc/ofelia/config.ini
    depends_on:
      - jeedom
    environment:
      - TZ=${TZ:-Europe/Paris}
    networks:
      - local_net


  db:
    container_name: db
    image: ghcr.io/linuxserver/mariadb
    restart: unless-stopped
        # env_file:
        #     - ./.env
    environment:
      - PUID=1000
      - PGID=1000
      - MYSQL_ROOT_PASSWORD=admin
      - TZ=${TZ:-Europe/Paris}
      - MYSQL_ALLOW_EMPTY_PASSWORD=yes
      - MYSQL_DATABASE=jeedom #optional
      - MYSQL_USER=jeedom #optional
      - MYSQL_PASSWORD=jeedom #optional
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      interval: 1m30s
      retries: 3
      start_period: 40s
      timeout: 20s
    volumes:
      - ./db:/config
      - /etc/timezone:/etc/timezone:ro
    ports:
      - 3306:3306
    networks:
      - local_net


  adminer:
    container_name: adminer
    image: adminer
    restart: unless-stopped
    labels:
      - "traefik.http.routers.adminer.rule=Host(`db.nico.si`)"
    networks:
      - local_net


  portainer:
    container_name: portainer
    image: portainer/portainer-ce
    privileged: true
    environment:
      - TZ=${TZ:-Europe/Paris}
    ports:
      - 8000:8000
      - 9000:9000
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./portainer:/data
    networks:
      - local_net
    labels:
      - traefik.http.routers.portainer-route.rule=Host(`portainer.nico.si`)
      - traefik.http.services.portainer-service.loadbalancer.server.port=8000
      - traefik.http.routers.portainer-route.service=portainer-service
      - traefik.http.routers.admin-route.rule=Host(`admin.nico.si`)
      - traefik.http.services.admin-service.loadbalancer.server.port=9000
      - traefik.http.routers.admin-route.service=admin-service


  homebridge:
    image: oznu/homebridge:latest
    container_name: homebridge
    restart: unless-stopped
    # network_mode: host
    environment:
      - TZ=${TZ:-Europe/Paris}
      - PGID=1000
      - PUID=1000
      - HOMEBRIDGE_CONFIG_UI=1
      - HOMEBRIDGE_CONFIG_UI_PORT=8581
    volumes:
      - ./homebridge:/homebridge
    labels:
      - "traefik.http.routers.homebridge.rule=Host(`homebridge.nico.si`)"
    networks:
      - local_net


  whoami:
    # A container that exposes an API to show its IP address
    image: containous/whoami
    container_name: whoami
    labels:
      - "traefik.http.routers.whoami.rule=Host(`whoami.nico.si`)"
    networks:
      - local_net


  zwave:
    container_name: zwave
    image: zwavejs/zwavejs2mqtt
    ports:
      - 3000:3000
      - 8091:8091
    devices:
    #  - "/dev/ttyUSB0"
    #  - "/dev/ttyUSB1"
      - "/dev/ttyACM0"
    volumes:
      - ./zwave:/usr/src/app/store
    depends_on:
      - mqtt
    networks:
      - local_net
    labels:
      - "traefik.http.routers.zwave.rule=Host(`zwave.nico.si`)"
      - "traefik.http.services.zwave.loadbalancer.server.port=8091"


  mqtt:
    image: eclipse-mosquitto:1.6
    container_name: mqtt
    ports:
      - 1883:1883 #Uniquement si besoin d'avoir le port expos√©
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout -t 5 mosquitto_sub -t '$$SYS/#' -C 1 | grep -v Error || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 3
    networks:
      - local_net


  reverse-proxy:
    # The official v2 Traefik docker image
    image: traefik:v2.5
    container_name: traefik
    # Enables the web UI and tells Traefik to listen to docker
    # command: --api.insecure=true --providers.docker --log.level=DEBUG
    environment:
      - TZ=${TZ:-Europe/Paris}
      - OVH_ENDPOINT=${OVH_ENDPOINT:?OVH Endpoint missing}
      - OVH_APPLICATION_KEY=${OVH_APPLICATION_KEY:?OVH App Key missing}
      - OVH_APPLICATION_SECRET=${OVH_APPLICATION_SECRET:?OVH App Secret missing}
      - OVH_CONSUMER_KEY=${OVH_CONSUMER_KEY:?OVH Consumer key missing}
    ports:
      # The HTTP port
      - 80:80
      # https port
      - 443:443
    volumes:
      # So that Traefik can listen to the Docker events
      - /var/run/docker.sock:/var/run/docker.sock
      # for HTTPS certificates
      - ./certs:/letsencrypt
      # Traefik yaml configuration
      - ./traefik.toml:/etc/traefik/traefik.toml
    networks:
      - local_net
    # Dynamic Configuration
    labels:
      - traefik.enable=true
      # - "traefik.http.routers.api.rule=Host(`traefik.nico.si`)"
      # - "traefik.http.routers.api.service=api@internal"
      # - "traefik.http.routers.dashboard.middlewares=auth"
      # - "traefik.http.middlewares.auth.basicauth.users=test:$$apr1$$H6uskkkW$$IgXLP6ewTrSuBkTrqE8wj/,test2:$$apr1$$d9hr9HBB$$4HxwgUir3HP4EsggP/QNo0"
      - traefik.http.routers.traefik-secure.entrypoints=websecure
      - traefik.http.routers.traefik-secure.rule=Host(`traefik.nico.si`)
      # - traefik.http.routers.traefik-secure.middlewares: authentification@file
      - traefik.http.routers.traefik-secure.tls=true
      - traefik.http.routers.traefik-secure.tls.certresolver=myresolver
      - traefik.http.routers.traefik-secure.tls.domains[0].main="nico.si"
      - traefik.http.routers.traefik-secure.tls.domains[0].sans="*.nico.si"
      - traefik.http.routers.traefik-secure.service=api@internal


  elasticsearch:
    image: "docker.elastic.co/elasticsearch/elasticsearch:7.2.0"
    restart: unless-stopped
    environment:
        - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
        - "discovery.type=single-node"
    ports:
        - "9200:9200"
    volumes:
        - ./elasticsearch:/usr/share/elasticsearch/data
    networks:
      - local_net


  kibana:
    image: "docker.elastic.co/kibana/kibana:7.2.0"
    restart: unless-stopped
    depends_on:
      - filebeat
      - elasticsearch
    ports:
        - "5601:5601"
    labels:
      - "traefik.http.routers.kibana.rule=Host(`kibana.nico.si`)"
    networks:
      - local_net


  filebeat:
    image: "docker.elastic.co/beats/filebeat:7.2.0"
    restart: unless-stopped
    user: root
    volumes:
      - ./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /var/lib/docker:/var/lib/docker:ro
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - local_net
